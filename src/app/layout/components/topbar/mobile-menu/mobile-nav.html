<div class="lg:hidden flex items-center">
  <button
    (click)="toggleNav()"
    class="p-2.5 -mr-2 rounded-xl active:scale-95 transition-all duration-150 active:bg-gray-100"
    aria-label="Toggle navigation">
    <i-lucide
      [name]="isOpen() ? icons.close : icons.menu"
      class="size-6 text-gray-700 transition-transform duration-300"
      [ngClass]="{'rotate-180 scale-110': isOpen()}" />
  </button>

  @if (isOpen()) {
  <button
    type="button"
    class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] cursor-default transition-opacity duration-300"
    (click)="toggleNav()"
    aria-label="Close navigation"></button>
  }

  <div
    class="fixed top-0 left-0 w-[85vw] max-w-[360px] h-dvh bg-gradient-to-b from-white to-gray-50/50 shadow-2xl z-[110] overflow-hidden flex flex-col transition-transform duration-300 ease-out"
    [ngClass]="isOpen() ? 'translate-x-0' : '-translate-x-full'">
    <div class="flex items-center justify-between px-6 py-6 border-b border-gray-100 bg-white/80 backdrop-blur-sm">
      <div class="flex items-center gap-2.5">
        <div class="w-10 h-10 rounded-xl bg-primary-500 flex items-center justify-center shadow-sm">
          <img src="/images/logo/logo-g.png" alt="logo" class="w-6 h-7 brightness-0 invert" />
        </div>
        <div>
          <h2 class="text-base font-bold text-gray-900">Menu</h2>
          <p class="text-xs text-gray-500">Navigation</p>
        </div>
      </div>
      <button
        (click)="toggleNav()"
        class="p-2 rounded-lg active:scale-95 active:bg-gray-100 transition-all"
        aria-label="Close menu">
        <i-lucide [name]="icons.close" class="size-5 text-gray-600" />
      </button>
    </div>

    @if (user(); as user) {
    <div class="mx-4 mt-4 mb-2 p-4 rounded-2xl bg-white shadow-sm border border-gray-100">
      <div class="flex items-center gap-3">
        <div class="relative w-12 h-12 rounded-full ring-2 ring-primary-100 overflow-hidden flex-shrink-0">
          <img [src]="user | apiIMG: 'user'" alt="{{ user.name }}" class="w-full h-full object-cover bg-gray-100" />
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-semibold text-gray-900 truncate">{{ user.name }}</p>
          <p class="text-xs text-gray-500 truncate">{{ user.email }}</p>
        </div>
      </div>
    </div>
    }

    <nav class="flex-1 overflow-y-auto px-4 py-4 space-y-1">
      @for (link of links(); track $index) { @if ((link?.children?.length || 0) > 0) {
      <div class="mb-1">
        <button
          class="w-full flex justify-between items-center px-4 py-3 font-semibold rounded-xl active:scale-[0.98] transition-all duration-150"
          (click)="onToggleTab(link.name)"
          [ngClass]="{
                'bg-primary-500 text-white shadow-md shadow-primary-500/20': isTabOpen(link.name),
                'text-gray-700 active:bg-gray-100': !isTabOpen(link.name)
              }">
          <div class="inline-flex gap-3 items-center">
            <i-lucide [name]="link.icon" class="size-5" />
            <span class="text-[15px]">{{ link.name }}</span>
          </div>
          <i-lucide
            [name]="icons.chevronDown"
            class="size-4 transition-transform duration-300"
            [ngClass]="{
                  'rotate-180': isTabOpen(link.name)
                }" />
        </button>
        @if (isTabOpen(link.name)) {
        <div
          class="mt-2 ml-5 pl-4 border-l-2 border-primary-200 space-y-0.5 animate-in slide-in-from-top-2 duration-200">
          @for (child of link.children; track $index) {
          <a
            class="flex items-center gap-3 py-1 px-4 text-sm text-gray-600 rounded-lg active:scale-[0.98] transition-all duration-150"
            [routerLink]="child.path"
            [routerLinkActive]="'bg-primary-50 text-primary-700 font-semibold !border-l-[3px] border-primary-500 -ml-[2px] shadow-sm'"
            [routerLinkActiveOptions]="{ exact: child.exactUrl || false }"
            (click)="toggleNav()">
            <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
            <span>{{ child.name }}</span>
          </a>
          }
        </div>
        }
      </div>
      } @else {
      <a
        [routerLink]="link.path"
        class="flex items-center gap-3 px-4 py-3 font-semibold rounded-xl active:scale-[0.98] transition-all duration-150 text-gray-700 active:bg-gray-100"
        [routerLinkActiveOptions]="{ exact: link.exactUrl || false }"
        [routerLinkActive]="'bg-primary-500 text-white shadow-md shadow-primary-500/20'"
        (click)="onToggleTab(link.name)"
        (click)="toggleNav()">
        <i-lucide [name]="link.icon" class="size-5" />
        <span class="text-[15px]">{{ link.name }}</span>
      </a>
      } }
    </nav>

    <div class="mt-auto border-t border-gray-100 p-4 bg-white/90 backdrop-blur-sm">
      <div class="relative group">
        <button
          class="w-full flex items-center justify-center gap-2.5 px-4 py-3 font-semibold text-red-600 bg-red-50 rounded-xl active:scale-[0.98] active:bg-red-100 hover:bg-red-100 hover:text-red-700 transition-all duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-200"
          (click)="handleSignOut()">
          <i-lucide [name]="icons.logOut" class="size-5" />
          <span class="text-sm">Se d√©connecter</span>
        </button>
      </div>
    </div>
  </div>
</div>
