<section class="text-gray-600">
  @let program = programSignal(); @let isLoading = store.isLoading(); @let subprograms =
  store.unpaginatedSubprograms();
  <div class="pt-6 pb-4 border-b border-gray-100">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h4 class="text-2xl font-bold text-gray-900 mb-1">Sous-programmes</h4>
        <p class="text-sm text-gray-500">
          Gérez les sous-programmes associés à
          <span class="font-semibold text-gray-900">{{ program?.name || 'ce programme' }}</span>
        </p>
      </div>
      <div class="flex items-center gap-3">
        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">
          {{ subprograms.length }} élément(s)
        </span>
        <ui-button size="small" variant="primary" [disabled]="!program" (clicked)="onToggleForm()">
          <i-lucide [name]="icons.plus" class="size-4" />
          {{ formVisible() ? 'Fermer le formulaire' : 'Ajouter unprogramme' }}
        </ui-button>
      </div>
    </div>
  </div>

  <div
    class="rounded-2xl border border-gray-200 bg-linear-to-br from-gray-50 to-white shadow-sm transition-all duration-500 ease-in-out overflow-hidden"
    [style.maxHeight]="formVisible() ? '900px' : '0px'"
    [style.opacity]="formVisible() ? 1 : 0"
    [style.padding]="formVisible() ? '24px' : '0 24px'">
    <form class="space-y-6" [formGroup]="subprogramForm" (ngSubmit)="onSubmit()">
      <div class="flex flex-col gap-1">
        <p class="text-base font-semibold text-gray-900">
          {{ formMode() === 'edit' ? 'Modifier le sous-programme' : 'Ajouter un sous-programme' }}
        </p>
        <p class="text-xs text-gray-500">
          {{
            formMode() === 'edit'
              ? 'Mettez à jour les détails sélectionnés.'
              : 'Décrivez un nouveau programme.'
          }}
        </p>
      </div>
      <div class="grid grid-cols-1 gap-6">
        <div class="space-y-2">
          <label for="sub-name" class="block text-sm font-semibold text-gray-700">
            Nom du sous-programme
            <span class="text-red-500">*</span>
          </label>
          <ui-input
            id="sub-name"
            formControlName="name"
            placeholder="Nom du sous-programme"
            class="w-full" />
        </div>
        <div class="space-y-2">
          <label for="sub-description" class="block text-sm font-semibold text-gray-700">
            Description
            <span class="text-red-500">*</span>
          </label>
          <textarea
            ui-textarea
            id="sub-description"
            formControlName="description"
            rows="5"
            placeholder="Décrivez brièvement le sous-programme..."
            class="w-full resize-none"></textarea>
        </div>
      </div>
      @if (formMode() === 'edit' && editingSubprogram()) {
      <div class="rounded-xl border w-full md:w-1/2 border-dashed border-gray-300 bg-white p-4">
        <p class="text-xs font-semibold text-gray-600 mb-3">Logo</p>
        <ui-file-upload [name]="'logo'" [url]="url + editingSubprogram()?.id" />
      </div>
      }
      <div class="flex items-center justify-end gap-3 pt-2 border-t border-gray-100">
        <ui-button
          type="button"
          size="small"
          variant="secondary"
          [outlined]="true"
          (clicked)="onCancelForm()">
          Annuler
        </ui-button>
        <ui-button
          type="submit"
          size="small"
          variant="primary"
          [disabled]="subprogramForm.invalid || store.isLoading()"
          [loading]="store.isLoading()">
          {{ formMode() === 'edit' ? 'Mettre à jour' : 'Ajouter' }}
        </ui-button>
      </div>
    </form>
  </div>
  <div class="mt-8">
    @if (isLoading) {
    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="px-6 py-3 font-bold text-gray-900 bg-white">Sous-programme</th>
            <th class="px-6 py-3 font-bold text-gray-900 bg-white">Statut</th>
            <th class="px-6 py-3 font-bold text-gray-900 bg-white">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100">
          @for (i of skeletonArray; track $index) {
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-lg bg-gray-200 animate-pulse"></div>
                <div class="space-y-2">
                  <div class="h-4 w-48 bg-gray-200 rounded animate-pulse"></div>
                  <div class="h-3 w-32 bg-gray-200 rounded animate-pulse"></div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="h-6 w-24 bg-gray-200 rounded-full animate-pulse"></div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <div class="h-8 w-8 bg-gray-200 rounded-md animate-pulse"></div>
                <div class="h-8 w-8 bg-gray-200 rounded-md animate-pulse"></div>
                <div class="h-8 w-8 bg-gray-200 rounded-md animate-pulse"></div>
                <div class="h-8 w-8 bg-gray-200 rounded-md animate-pulse"></div>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    } @else if (!subprograms.length) {
    <div class="text-center py-16 px-6 border border-dashed border-gray-200 rounded-xl bg-gray-50">
      <div
        class="w-20 h-20 bg-linear-to-br from-primary-50 to-primary-100 rounded-3xl flex items-center justify-center mb-5">
        <i-lucide [name]="icons.plus" class="text-primary-600 w-10 h-10 stroke-[1.5]" />
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun sous-programme</h3>
      <p class="text-sm text-gray-500 max-w-md mx-auto mb-6">
        Ajoutez votre premier sous-programme pour structurer vos initiatives au sein de ce
        programme.
      </p>
      <ui-button
        variant="primary"
        [outlined]="true"
        size="small"
        [disabled]="!program"
        (clicked)="onToggleForm()">
        Créer un sous-programme
      </ui-button>
    </div>
    } @else {
    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="px-6 py-3 font-bold text-gray-900 bg-white">Sous-programme</th>
            <th class="px-6 py-3 font-bold text-gray-900 bg-white">Statut</th>
            <th class="px-6 py-3 font-bold text-gray-900 bg-white">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100">
          @for (program of subprograms; track program.id) {
          <tr
            class="border-b border-gray-100 last:border-none hover:bg-gray-50 transition-colors duration-150">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="relative">
                  <ui-avatar [image]="program | apiIMG : 'subprogram'" [label]="program.name" />
                  @if (program.is_highlighted) {
                  <div
                    class="absolute -top-1 -right-1 w-5 h-5 bg-amber-400 rounded-full flex items-center justify-center border-2 border-white shadow-sm">
                    <i-lucide [name]="icons.star" class="size-2.5 text-white" />
                  </div>
                  }
                </div>
                <div class="min-w-0">
                  <p class="font-semibold text-gray-900">{{ program.name }}</p>
                  <p class="text-xs text-gray-500 mt-0.5">
                    Créé le {{ program.created_at | date : 'dd MMM yyyy' }}
                  </p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4">
              @if (program.is_published) {
              <span
                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">
                <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
                Publié
              </span>
              } @else {
              <span
                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                Brouillon
              </span>
              }
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <ui-button
                  size="small"
                  [variant]="program.is_highlighted ? 'contrast' : 'secondary'"
                  (clicked)="highlightSubprogram(program.id)">
                  <i-lucide
                    [name]="program.is_highlighted ? icons.star : icons.starOff"
                    class="size-4" />
                </ui-button>
                <ui-button
                  size="small"
                  [variant]="program.is_published ? 'success' : 'secondary'"
                  (clicked)="onPublishProgram(program.id)">
                  <i-lucide
                    [name]="program.is_published ? icons.eye : icons.eyeOff"
                    class="size-4" />
                </ui-button>
                <ui-button size="small" variant="info" (clicked)="onToggleForm(program)">
                  <i-lucide [name]="icons.edit" class="size-4" />
                </ui-button>
                <ui-button
                  size="small"
                  variant="danger"
                  (clicked)="onDeleteRole(program.id, $event)">
                  <i-lucide [name]="icons.trash" class="size-4" />
                </ui-button>
                <ui-confirm-dialog />
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>
</section>
