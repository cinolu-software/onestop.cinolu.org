<div class="space-y-6">
  <div class="flex flex-col xl:flex-row xl:items-center xl:justify-between gap-4">
    <div>
      <h6 class="text-lg font-semibold text-gray-900">Formulaires de la phase</h6>
      <p class="text-sm text-gray-500">
        Configurez des formulaires pour
        <span class="font-medium text-gray-700">{{ phase().name }}</span> du projet
        <span class="font-medium text-gray-700">{{ project().name }}</span>
        <span class="text-gray-400">
          • {{ formsStore.forms().length }} formulaire{{ formsStore.forms().length > 1 ? 's' : '' }}
        </span>
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <ui-button
        size="small"
        variant="primary"
        (clicked)="resetFormEditorState(false); showFormEditor.set(true)">
        <span class="flex items-center gap-2">
          <i-lucide [name]="icons.plus" class="size-4" />
          <span>{{ editingFormId() ? 'Modifier le formulaire' : 'Nouveau formulaire' }}</span>
        </span>
      </ui-button>
    </div>
  </div>
  @if (showFormEditor()) {
  <div class="rounded-xl border border-gray-200 shadow-sm bg-white p-6 space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Construction</p>
        <h6 class="text-lg font-semibold text-gray-900">
          {{ editingFormId() ? 'Modifier le formulaire' : 'Nouveau formulaire' }}
        </h6>
      </div>
      <ui-button
        variant="secondary"
        [outlined]="true"
        size="small"
        (clicked)="toggleFormEditor(false)">
        Fermer
      </ui-button>
    </div>
    <form class="space-y-6" [formGroup]="formForm" (ngSubmit)="onSubmitForm()">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex flex-col gap-1.5">
          <label for="form-title" class="text-sm font-medium text-gray-700">
            Titre du formulaire <span class="text-red-500">*</span>
          </label>
          <ui-input
            id="form-title"
            formControlName="title"
            placeholder="Ex: Formulaire de candidature"
            class="w-full" />
        </div>
        <div class="flex flex-col gap-1.5">
          <span class="text-sm font-medium text-gray-700">Statut</span>
          <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg">
            <ui-checkbox formControlName="is_active" id="form-is-active" />
            <label for="form-is-active" class="text-sm font-medium text-gray-700 cursor-pointer">
              Formulaire actif
            </label>
          </div>
        </div>
        <div class="flex flex-col gap-1.5 md:col-span-2">
          <label for="form-description" class="text-sm font-medium text-gray-700"
            >Description</label
          >
          <ui-textarea
            id="form-description"
            formControlName="description"
            [rows]="5"
            placeholder="Expliquez l'objectif du formulaire"></ui-textarea>
        </div>
      </div>
      <div class="space-y-4" formArrayName="fields">
        <div class="flex items-center justify-between gap-4">
          <div>
            <p class="text-sm font-semibold text-gray-900">Champs du formulaire</p>
            <p class="text-xs text-gray-500">
              Ajoutez les questions ou champs requis pour cette phase.
            </p>
          </div>
          <ui-button size="small" (clicked)="addField()">
            <span class="flex items-center gap-2">
              <i-lucide [name]="icons.plus" class="size-4" />
              <span>Ajouter un champ</span>
            </span>
          </ui-button>
        </div>
        @for (fieldGroup of fieldsArray.controls; track $index; let idx = $index) {
        <div class="border border-gray-200 rounded-xl p-4 space-y-3" [formGroupName]="idx">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-semibold text-gray-900">
                Champ {{ idx + 1 }} • {{ fieldTypeLabel(fieldGroup.controls.type.value) }}
              </p>
              <p class="text-xs text-gray-500">
                {{ fieldGroup.controls.required.value ? 'Obligatoire' : 'Facultatif' }}
              </p>
            </div>
            <ui-button
              variant="danger"
              [outlined]="true"
              size="small"
              (clicked)="removeField(idx)"
              [disabled]="fieldsArray.length === 1">
              Supprimer
            </ui-button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col gap-1.5">
              <label class="text-xs font-medium text-gray-500" [attr.for]="'field-label-' + idx"
                >Libellé</label
              >
              <ui-input formControlName="label" placeholder="Question ou intitulé" />
            </div>
            <div class="flex flex-col gap-1.5">
              <label class="text-xs font-medium text-gray-500" [attr.for]="'field-type-' + idx">
                Type de champ
              </label>
              <ui-select formControlName="type" [options]="fieldTypeOptions"></ui-select>
            </div>
            <div class="flex flex-col gap-1.5">
              <label
                class="text-xs font-medium text-gray-500"
                [attr.for]="'field-placeholder-' + idx">
                Placeholder
              </label>
              <ui-input formControlName="placeholder" placeholder="Texte indicatif" />
            </div>
            <div class="flex items-center gap-2">
              <ui-checkbox formControlName="required" [id]="'field-' + idx + '-required'" />
              <label
                [for]="'field-' + idx + '-required'"
                class="text-sm text-gray-700 cursor-pointer">
                Réponse obligatoire
              </label>
            </div>
          </div>
          @if (shouldDisplayOptions(fieldGroup.controls.type.value)) {
          <div
            class="border border-dashed border-gray-200 rounded-lg p-4 space-y-3 bg-gray-50/50"
            formArrayName="options">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-gray-800">Options</p>
              <ui-button size="small" [outlined]="true" (clicked)="addOption(idx)">
                <span class="flex items-center gap-2">
                  <i-lucide [name]="icons.plus" class="size-3.5" />
                  <span>Ajouter une option</span>
                </span>
              </ui-button>
            </div>
            @if (fieldOptionsArray(idx).length === 0) {
            <p class="text-xs text-gray-500">Ajoutez au moins une option pour ce type de champ.</p>
            }
            <div class="space-y-3">
              @for (optionGroup of fieldOptionsArray(idx).controls; track $index; let optIndex =
              $index) {
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3" [formGroupName]="optIndex">
                <div class="flex flex-col gap-1.5">
                  <label
                    class="text-xs font-medium text-gray-500"
                    [for]="'field-' + idx + '-option-label-' + optIndex">
                    Label
                  </label>
                  <ui-input
                    formControlName="label"
                    [id]="'field-' + idx + '-option-label-' + optIndex"
                    placeholder="Ex: Choix A" />
                </div>
                <div class="flex flex-col gap-1.5">
                  <label
                    class="text-xs font-medium text-gray-500"
                    [for]="'field-' + idx + '-option-value-' + optIndex">
                    Valeur
                  </label>
                  <div class="flex items-center gap-2">
                    <ui-input
                      formControlName="value"
                      [id]="'field-' + idx + '-option-value-' + optIndex"
                      placeholder="Valeur unique" />
                    <ui-button
                      type="button"
                      variant="danger"
                      [text]="true"
                      (clicked)="removeOption(idx, optIndex)">
                      <i-lucide [name]="icons.trash" class="size-4" />
                    </ui-button>
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
          }
        </div>
        }
      </div>
      <div class="flex justify-end gap-3 pt-2">
        <ui-button
          type="button"
          variant="secondary"
          [outlined]="true"
          size="small"
          (clicked)="toggleFormEditor(false)">
          Annuler
        </ui-button>
        <ui-button
          type="submit"
          variant="primary"
          size="small"
          [disabled]="formForm.invalid || fieldsArray.length === 0 || formsStore.isLoading()"
          [loading]="formsStore.isLoading()">
          {{ editingFormId() ? 'Mettre à jour' : 'Enregistrer' }}
        </ui-button>
      </div>
    </form>
  </div>
  } @if (formsStore.isLoading() && !showFormEditor()) {
  <div class="space-y-3">
    @for (item of [1, 2]; track item) {
    <div class="h-28 rounded-xl bg-gradient-to-r from-gray-200 to-gray-100 animate-pulse"></div>
    }
  </div>
  } @else if (!formsStore.forms().length && !showFormEditor()) {
  <div
    class="flex flex-col items-center justify-center py-14 px-6 bg-gray-50/70 rounded-xl border border-dashed border-gray-200">
    <div class="w-16 h-16 rounded-2xl bg-white shadow-sm flex items-center justify-center mb-4">
      <i-lucide [name]="icons.form" class="text-primary-600 size-8" />
    </div>
    <h6 class="text-lg font-semibold text-gray-900 mb-2">Aucun formulaire</h6>
    <p class="text-sm text-gray-500 text-center max-w-md">
      Créez un premier formulaire pour capturer les informations nécessaires à cette phase.
    </p>
  </div>
  } @else {
  <div class="space-y-3">
    @for (form of formsStore.forms(); track form.id) {
    <div
      class="p-5 bg-white rounded-xl border border-gray-200 hover:border-primary-200 hover:shadow-sm transition-all duration-300">
      <div class="flex flex-col lg:flex-row lg:items-start gap-4 justify-between">
        <div class="flex-1 space-y-2">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-lg bg-primary-50 flex items-center justify-center text-primary-600">
              <i-lucide [name]="icons.form" class="size-5" />
            </div>
            <div>
              <h6 class="text-base font-semibold text-gray-900">{{ form.title }}</h6>
              <p class="text-xs text-gray-500">{{ form.description || 'Sans description' }}</p>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-500">
            <span>{{ form.fields.length }} champ{{ form.fields.length > 1 ? 's' : '' }}</span>
            <span>•</span>
            <span
              class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold"
              [ngClass]="{
                'bg-green-50 text-green-700 border border-green-100': form.is_active,
                'bg-gray-100 text-gray-600 border border-gray-200': !form.is_active
              }">
              {{ form.is_active ? 'Actif' : 'Inactif' }}
            </span>
          </div>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <ui-button [outlined]="true" variant="primary" size="small" (clicked)="onEditForm(form)">
            <span class="flex items-center gap-1.5 text-sm">
              <i-lucide [name]="icons.edit" class="size-4" />
              Modifier
            </span>
          </ui-button>
          <ui-button variant="danger" size="small" (clicked)="onDeleteForm(form.id)">
            <span class="flex items-center gap-1.5 text-sm">
              <i-lucide [name]="icons.trash" class="size-4" />
              Supprimer
            </span>
          </ui-button>
        </div>
      </div>
    </div>
    }
  </div>
  }
</div>
