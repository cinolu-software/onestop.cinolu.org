<div class="relative bg-white rounded-xl shadow-sm">
  <div class="px-6 pt-6 pb-4 border-b border-gray-100">
    <div class="flex flex-col md:flex-row gap-4 md:justify-between md:items-center">
      <div>
        <h5 class="text-2xl font-bold text-gray-900 mb-1">Phases du projet</h5>
        <p class="text-sm text-gray-500">
          Organisez votre projet en phases @if (!phasesStore.isLoading()) {
          <span class="text-gray-400">
            • {{ phasesStore.phases().length }} phase{{
              phasesStore.phases().length > 1 ? 's' : ''
            }}
          </span>
          }
        </p>
      </div>
      <ui-button
        size="small"
        (clicked)="showPhaseForm.set(true); editingPhaseId.set(null); resetPhaseForm()"
        variant="primary">
        <span class="flex items-center gap-2">
          <i-lucide [name]="icons.plus" class="size-4" />
          <span>Nouvelle phase</span>
        </span>
      </ui-button>
    </div>
  </div>
  <div class="p-6 space-y-6">
    @if (showPhaseForm()) {
    <div
      class="bg-linear-to-br from-primary-50/50 to-white border-2 border-primary-200 rounded-xl p-6">
      <h6 class="text-lg font-semibold text-gray-900 mb-4">
        {{ editingPhaseId() ? 'Modifier la phase' : 'Nouvelle phase' }}
      </h6>
      <form class="flex flex-col gap-4" [formGroup]="phaseForm" (ngSubmit)="onSubmitPhase()">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex flex-col gap-1.5 md:col-span-2">
            <label for="phase-name" class="font-medium text-sm">
              Nom de la phase<span class="text-red-500 ml-1">*</span>
            </label>
            <ui-input
              id="phase-name"
              formControlName="name"
              placeholder="Ex: Phase de conception" />
          </div>
          <div class="flex flex-col gap-1.5 md:col-span-2">
            <label for="phase-description" class="font-medium text-sm">Description</label>
            <textarea
              ui-textarea
              id="phase-description"
              formControlName="description"
              rows="3"
              placeholder="Description de la phase..."></textarea>
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="phase-started" class="font-medium text-sm">Date de début</label>
            <ui-datepicker inputId="phase-started" formControlName="started_at" class="w-full" />
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="phase-ended" class="font-medium text-sm">Date de fin</label>
            <ui-datepicker inputId="phase-ended" formControlName="ended_at" class="w-full" />
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="phase-order" class="font-medium text-sm">Ordre</label>
            <input
              type="number"
              id="phase-order"
              formControlName="order"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" />
          </div>
          <div class="flex items-end pb-1.5">
            <div class="flex items-center gap-2">
              <ui-checkbox formControlName="is_active" id="phase-active" />
              <label for="phase-active" class="font-medium text-sm cursor-pointer"
                >Phase active</label
              >
            </div>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <ui-button
            size="small"
            [outlined]="true"
            variant="secondary"
            (clicked)="showPhaseForm.set(false); resetPhaseForm()">
            <span>Annuler</span>
          </ui-button>
          <ui-button
            type="submit"
            size="small"
            variant="primary"
            [disabled]="phaseForm.invalid || phasesStore.isLoading()"
            [loading]="phasesStore.isLoading()">
            <span>{{ editingPhaseId() ? 'Mettre à jour' : 'Créer la phase' }}</span>
          </ui-button>
        </div>
      </form>
    </div>
    } @if (phasesStore.isLoading()) {
    <div class="space-y-3">
      @for (item of [1, 2, 3]; track item) {
      <div class="h-32 bg-gray-200 animate-pulse rounded-xl"></div>
      }
    </div>
    } @else if (phasesStore.phases().length === 0 && !showPhaseForm()) {
    <div class="flex flex-col items-center justify-center py-16 px-6">
      <div
        class="w-20 h-20 bg-linear-to-br from-primary-50 to-primary-100 rounded-3xl flex items-center justify-center mb-5">
        <i-lucide [name]="icons.list" class="text-primary-600 w-10 h-10 stroke-[1.5]" />
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">Aucune phase</h3>
      <p class="text-gray-500 text-center max-w-md mb-6 text-sm leading-relaxed">
        Commencez par créer des phases pour structurer votre projet et y ajouter des ressources.
      </p>
      <ui-button
        (clicked)="showPhaseForm.set(true); editingPhaseId.set(null); resetPhaseForm()"
        [size]="'small'"
        variant="primary">
        <span class="flex items-center gap-2">
          <i-lucide [name]="icons.plus" class="size-4" />
          <span>Créer une phase</span>
        </span>
      </ui-button>
    </div>
    } @else {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      @for (phase of phasesStore.phases(); track phase.id) {
      <app-phase-card
        [phase]="phase"
        [isSelected]="phasesStore.selectedPhase()?.id === phase.id"
        (phaseSelect)="selectPhase($event)"
        (phaseEdit)="onEditPhase($event)"
        (phaseDelete)="onDeletePhase($event)" />
      }
    </div>
    }
  </div>

  @if (phasesStore.selectedPhase()) {
  <div class="border-t border-gray-100">
    <div class="px-6 pt-6 bg-gray-50/50 space-y-4">
      <ui-tabs
        [tabs]="phaseTabs"
        [activeTab]="activePhaseSection()"
        (tabChange)="onPhaseTabChange($event)" />
    </div>
    <div class="p-6 bg-white">
      @if (activePhaseSection() === 'resources') {
      <app-phase-resources [phase]="phasesStore.selectedPhase()!" [project]="project()" />
      } @else {
      <app-phase-forms [phase]="phasesStore.selectedPhase()!" [project]="project()" />
      }
    </div>
  </div>
  }
</div>
