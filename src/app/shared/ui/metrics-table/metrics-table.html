@if (indicators().length) {
<div class="flex flex-col gap-6 w-full">
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden w-full md:w-2/4">
    <div class="p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
          <span>Performance Globale</span>
        </h3>
        <span class="text-xs text-gray-500">{{ totalIndicators() }} indicateurs</span>
      </div>
      <div class="flex items-center gap-6">
        <div class="flex-1 grid grid-cols-3 gap-3">
          <div>
            <p class="text-xs text-gray-500 mb-1">Attendu</p>
            <p class="text-xl font-bold text-blue-600">{{ totalTarget() }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Obtenu</p>
            <p class="text-xl font-bold text-green-600">{{ totalAchieved() }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Taux</p>
            <p
              class="text-xl font-bold"
              [class.text-red-600]="overallPerformance() < 50"
              [class.text-yellow-600]="overallPerformance() >= 50 && overallPerformance() < 80"
              [class.text-green-600]="overallPerformance() >= 80">
              {{ overallPerformance() }}%
            </p>
          </div>
        </div>
        <div class="shrink-0">
          <app-ui-circular-progress [percentage]="overallPerformance()" [size]="80" [strokeWidth]="6" />
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
    @for (group of groupedWithSummary(); track group.category) {
    <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm bg-white">
      <div class="bg-linear-to-r from-gray-50 to-gray-100 px-4 py-3 border-b border-gray-200">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-gray-800">{{ group.category }}</h4>
          <span class="text-xs text-gray-500">{{ group.indicators.length }} indicateur(s)</span>
        </div>

        <div class="flex items-center gap-4">
          <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
            <div
              class="h-full transition-all duration-500 ease-out"
              [class.bg-red-500]="group.summary.percentage < 50"
              [class.bg-yellow-500]="group.summary.percentage >= 50 && group.summary.percentage < 80"
              [class.bg-green-500]="group.summary.percentage >= 80"
              [style.width.%]="group.summary.percentage > 100 ? 100 : group.summary.percentage"></div>
          </div>
          <div class="shrink-0">
            <div
              class="flex items-center justify-center font-bold text-sm transition-all duration-300"
              [class.text-red-500]="group.summary.percentage < 50"
              [class.text-yellow-500]="group.summary.percentage >= 50 && group.summary.percentage < 80"
              [class.text-green-500]="group.summary.percentage >= 80">
              {{ group.summary.percentage }}%
            </div>
          </div>
        </div>
      </div>
      <div class="p-4">
        <div class="flex flex-col gap-3">
          @for (indicator of group.indicators; track indicator.id) {
          <div class="flex flex-col gap-2 border-b border-gray-100 pb-3 last:border-0">
            <div class="flex items-center justify-between gap-4">
              <div class="flex-1">
                <div class="font-medium text-gray-800 text-sm">{{ indicator.name }}</div>
                @if (hasIndicatorTarget(indicator.id)) {
                <div class="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                  <span>Cible globale: {{ indicator.target }}</span>
                </div>
                }
              </div>
              <div class="w-full md:w-64 flex items-center gap-2">
                <div class="relative flex-1">
                  <input
                    type="number"
                    [(ngModel)]="metricsMap()[indicator.id].target"
                    (ngModelChange)="onTargetChange(indicator.id)"
                    [disabled]="hasExistingTarget(indicator.id)"
                    [max]="getIndicatorTargetLimit(indicator.id)"
                    class="text-sm w-full px-3 py-2 border border-gray-300 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                    [class.border-orange-400]="
                      hasIndicatorTarget(indicator.id) &&
                      metricsMap()[indicator.id].target &&
                      metricsMap()[indicator.id].target! > indicator.target!
                    "
                    placeholder="Attendu" />
                  @if (hasExistingTarget(indicator.id)) {
                  <i-lucide
                    [img]="icons.lock"
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                  }
                </div>
                <input
                  type="number"
                  [(ngModel)]="metricsMap()[indicator.id].achieved"
                  (ngModelChange)="onMetricChange()"
                  class="text-sm flex-1 px-3 py-2 border border-gray-300 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500"
                  placeholder="Obtenu" />
              </div>
            </div>
            @if (hasIndicatorTarget(indicator.id) && metricsMap()[indicator.id].target &&
            metricsMap()[indicator.id].target! > indicator.target!) {
            <div class="text-xs text-orange-600 flex items-center gap-1 ml-auto">
              <i-lucide [img]="icons.alertTriangle" class="w-4 h-4" />
              <span> La cible du projet ne peut pas dépasser la cible globale ({{ indicator.target }}) </span>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
    }
  </div>
  <div class="flex justify-end mt-4">
    <app-ui-button size="small" variant="info" [disabled]="isLoading()" [loading]="isLoading()" (clicked)="onSaveAll()">
      Enregistrer les indicateurs
    </app-ui-button>
  </div>
</div>
} @else {
<div
  class="flex flex-col items-center justify-center py-16 px-6 bg-linear-to-br from-gray-50 to-gray-100 rounded-2xl border-2 border-dashed border-gray-300">
  <div class="bg-white rounded-full w-20 h-20 flex items-center justify-center shadow-sm mb-6">
    <i-lucide [img]="icons.barChart" class="text-gray-400 w-10 h-10 stroke-[1.5]" />
  </div>
  <h3 class="text-2xl font-bold text-gray-800 mb-3">Aucun indicateur disponible</h3>
  <p class="text-gray-600 text-center max-w-md mb-2">
    Il n'y a pas encore d'indicateurs de performance configurés pour ce programme ou événement.
  </p>
  <p class="text-sm text-gray-500 text-center max-w-md">
    Veuillez d'abord ajouter des indicateurs pour pouvoir suivre les performances et générer des rapports.
  </p>
</div>
}
